REQUIRE_MODULE LUA

INCLUDE $TOP/test/config.htb

BLOCK:LUA readFile name : ret 
  assert(io.input(name))
  local buf = io.read("*all")
  return buf
END

BLOCK attack name code expect
  _MILESTONE $name
    _CODER:URLENC VAR(code) urlenc
    _REQ localhost 8080
    __GET /cgi-bin/test-cgi?param=$urlenc HTTP/1.1
    __Host: localhost:8080
    __Accept: text/html
    __User-Agent: httest/2.4.2 
    __
    _EXPECT headers "$expect"
    _WAIT

    _REQ localhost 8080
    __GET /cgi-bin/test-cgi?$urlenc=foo HTTP/1.1
    __Host: localhost:8080
    __Accept: text/html
    __User-Agent: httest/2.4.2 
    __
    _EXPECT headers "$expect"
    _WAIT

    _REQ localhost 8080
    __POST /cgi-bin/test-cgi HTTP/1.1
    __Host: localhost:8080
    __Content-Length: AUTO
    __Content-Type: application/x-www-form-urlencoded
    __Accept: text/html
    __User-Agent: httest/2.4.2 
    __
    _-param=$urlenc
    _EXPECT headers "$expect"
    _WAIT
  _END
END

CLIENT
  _AUTO_CLOSE on
  _REQ localhost 8080
  __GET /cgi-bin/test-cgi?foo=bar&bla=fasel HTTP/1.1
  __Host: localhost:8080
  __Accept: text/html
  __User-Agent: httest/2.4.2 
  __
  _EXPECT headers "HTTP/1.1 200"
  _WAIT

  _REQ localhost 8080
  __POST /cgi-bin/test-cgi HTTP/1.1
  __Host: localhost:8080
  __Content-Length: AUTO
  __Content-Type: application/x-www-form-urlencoded
  __Accept: text/html
  __User-Agent: httest/2.4.2 
  __
  _-foo=bar&bla=fasel
  _EXPECT headers "HTTP/1.1 200"
  _WAIT

  readFile "$TOP/test/xssAttacks.xml" BUF 
  _XML:PARSE VAR(BUF)
  _LOOP 113 i=1
    _XML:XPATH /xss/attack[$i]/name name 
    _XML:XPATH /xss/attack[$i]/code code 
    attack VAR(name) VAR(code) "HTTP/1.1 403"
  _END
END


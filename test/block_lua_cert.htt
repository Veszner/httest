REQUIRE lua_module

INCLUDE $TOP/test/config.htb

BLOCK:LUA MyCertSubjectName : name b64
  cert = [[
-----BEGIN CERTIFICATE-----
MIIDYTCCAsqgAwIBAgIBATANBgkqhkiG9w0BAQUFADCBhzEPMA0GA1UEAxMGaHR0
LmNhMQswCQYDVQQGEwJDSDEPMA0GA1UECBMGQWFyZ2F1MQ8wDQYDVQQHEwZXb2hs
ZW4xHDAaBgNVBAoTE2h0dC5zb3VyY2Vmb3JnZS5uZXQxJzAlBgkqhkiG9w0BCQEW
GGlhOTdsaWVzQHNvdXJjZWZvcmdlLm5ldDAeFw0xMTAxMTMyMjEwMDNaFw0yMTAx
MTAyMjEwMDNaMHYxCzAJBgNVBAYTAkNIMQ8wDQYDVQQIEwZBYXJnYXUxHDAaBgNV
BAoTE2h0dC5zb3VyY2Vmb3JnZS5uZXQxDzANBgNVBAMTBmh0dC5jYTEnMCUGCSqG
SIb3DQEJARYYaWE5N2xpZXNAc291cmNlZm9yZ2UubmV0MIGfMA0GCSqGSIb3DQEB
AQUAA4GNADCBiQKBgQDUGKpClhhzdQYFE+A+ROrUChgNivDerUl0fTuPh8EO1j4s
LjlVUM8s2PuDA4cKR+QvU7cLLNf3xcXav/+58BHOKitPZnz5MxX3CgsaVMURVoq+
GLEzPPponZrv4Sog7Y14tXAra9h8TSPfFX/oBdd35bY0uQTDvIuHgva7nzFYwwID
AQABo4HsMIHpMAkGA1UdEwQCMAAwHQYDVR0OBBYEFMiqXe9E1iq2OYmcFCX06jo/
wbDIMIG8BgNVHSMEgbQwgbGAFBnSZTcoCx5jO9S1H/VuI3Q86PRRoYGNpIGKMIGH
MQ8wDQYDVQQDEwZodHQuY2ExCzAJBgNVBAYTAkNIMQ8wDQYDVQQIEwZBYXJnYXUx
DzANBgNVBAcTBldvaGxlbjEcMBoGA1UEChMTaHR0LnNvdXJjZWZvcmdlLm5ldDEn
MCUGCSqGSIb3DQEJARYYaWE5N2xpZXNAc291cmNlZm9yZ2UubmV0ggkAnnLxobd7
aHcwDQYJKoZIhvcNAQEFBQADgYEAfwWdKkhRTEfig5QRqLaV/u7Nziwo+huo0Cur
AurLQzXt+Bung5iNqDAytIrOjfq+N7c+5zic3BItRMMO30/9J5qTNaJOwNdphRjO
i39ykFcqxz3kDfZknFNti0rYdADxSacJKzNsqRlhrQ/IkrXhZWo2FTOJHXW8/+xz
NFbyeF0=
-----END CERTIFICATE-----
  ]]

  cert = crypto.x509.new(cert);
  certname = cert:get_subject_name();
  certnamB64 = crypto.base64.encode(certname:toasn1());
  assert(certnamB64 == "MHYxCzAJBgNVBAYTAkNIMQ8wDQYDVQQIEwZBYXJnYXUxHDAaBgNVBAoTE2h0dC5zb3VyY2Vmb3JnZS5uZXQxDzANBgNVBAMTBmh0dC5jYTEnMCUGCSqGSIb3DQEJARYYaWE5N2xpZXNAc291cmNlZm9yZ2UubmV0");
  return certname:tostring(), crypto.base64.encode(certname:toasn1());
END

CLIENT
  MyCertSubjectName NAME B64
  _EXPECT VAR(NAME) "emailAddress=ia97lies"
  _EXPECT VAR(B64) "MHY.*Z2UubmV0"
END


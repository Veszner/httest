INCLUDE $TOP/test/config.htb

BLOCK:LUA WebsocketClient
  
  function lines(t)
    local state = { transport = t, buffer = t:read(8192), pos = 1 }
    return readline, state
  end

  function readline(self)
    while (self.buffer) do
      local s, e = string.find(self.buffer, "[^\r\n]*\r\n", self.pos)
      if s then
        self.pos = e + 1
        return string.sub(self.buffer, s, e-2)
      else
        self.buffer = self.transport:read(8192)
        self.pos = 1
      end
    end
    return nil
  end

  function readblock(self, len)
  end

  function readeof(self)
  end

  htt.interpret("_FLUSH")
  local func, state = lines(htt.get_transport())
  for line in func, state do
    print("XXX "..line)
    if (string.len(line) == 0) then
      break;
    end
  end
  print("Rest: "..string.sub(state.buffer, state.pos))
  
END

CLIENT
  _REQ $YOUR_HOST $YOUR_PORT
  __GET / HTTP/1.1
  __Host: httest
  __
  WebsocketClient
END

SERVER $YOUR_PORT
_RES
_WAIT
__HTTP/1.1 200 OK
__Content-Length: AUTO
__
_-== OK ==
END

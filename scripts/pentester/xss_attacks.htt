REQUIRE_MODULE LUA

SET host=localhost
SET port=8080
SET url=/cgi-bin/test-cgi

BLOCK:LUA readFile name : ret 
  assert(io.input(name))
  local buf = io.read("*all")
  return buf
END

BLOCK attack name code expect
  _MILESTONE $name
    _CODER:URLENC VAR(code) urlenc
    _REQ $host $port
    __GET $url?param=$urlenc HTTP/1.1
    __Host: $host:$port
    __Accept: text/html
    __User-Agent: httest/2.4.2 
    __
    _EXPECT headers "$expect"
    _WAIT

    _REQ $host $port
    __GET $url?$urlenc=foo HTTP/1.1
    __Host: $host:$port
    __Accept: text/html
    __User-Agent: httest/2.4.2 
    __
    _EXPECT headers "$expect"
    _WAIT

    _REQ $host $port
    __POST $url HTTP/1.1
    __Host: $host:$port
    __Content-Length: AUTO
    __Content-Type: application/x-www-form-urlencoded
    __Accept: text/html
    __User-Agent: httest/2.4.2 
    __
    _-param=$urlenc
    _EXPECT headers "$expect"
    _WAIT
  _END
END

CLIENT
  _AUTO_CLOSE on
  _REQ $host $port
  __GET $url?foo=bar&bla=fasel HTTP/1.1
  __Host: $host:$port
  __Accept: text/html
  __User-Agent: httest/2.4.2 
  __
  _EXPECT headers "HTTP/1.1 200"
  _WAIT

  _REQ $host $port
  __POST $url HTTP/1.1
  __Host: $host:$port
  __Content-Length: AUTO
  __Content-Type: application/x-www-form-urlencoded
  __Accept: text/html
  __User-Agent: httest/2.4.2 
  __
  _-foo=bar&bla=fasel
  _EXPECT headers "HTTP/1.1 200"
  _WAIT

  readFile "$TOP/test/xssAttacks.xml" BUF 
  _XML:PARSE VAR(BUF)
  _LOOP 113 i=1
    _XML:XPATH /xss/attack[$i]/name name 
    _XML:XPATH /xss/attack[$i]/code code 
    attack VAR(name) VAR(code) "HTTP/1.1 403"
  _END
END

